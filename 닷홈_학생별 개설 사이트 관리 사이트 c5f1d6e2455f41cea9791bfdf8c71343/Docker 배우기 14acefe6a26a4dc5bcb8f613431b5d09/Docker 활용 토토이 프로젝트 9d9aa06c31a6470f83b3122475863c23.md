# Docker 활용 토토이 프로젝트

생성일: 2021년 9월 18일 오후 9:14

도커를 활용하여 spring 빌드

1. 도커를 통해 spring 빌드
    - spring 프로젝트에 application.yml 환경 변수 전송하는 방법

        ```docker
        #application.yml
        datasource:
            url: jdbc:mysql://localhost:3306/testDB
            username: ${DB_USERNAME}
            password: ${DB_PASSWORD}
            driver-class-name: com.mysql.cj.jdbc.Driver
        #Dockerfile
        FROM adoptopenjdk/openjdk11
        ARG JAR_FILE=target/*.jar
        COPY ${JAR_FILE} app.jar
        ENV DB_PASSWORD=password
        ENV DB_USERNAME=root
        ENV PORT=8080
        RUN echo $PORT
        ENTRYPOINT java -DPORT=$PORT -DDB_PASSWORD=$DB_PASSWORD -DDB_USERNAME=$DB_USERNAME -jar ./app.jar
        ```

        환경변수를 dockerFIlefh 전송할 수 있지만 mvn cleaen ,package등 maven 명령어를 실행시키고 docker build를 하는 부분이 번거러움 → maven , docker 연결이 요구되어 진다.

2. Docker-compose를 활용하여 spring , mysql 동시에 빌드

    네트워크와 환경 변수 지정이 중요하니 꼭 지정한다.

    ```docker
    version: "3"

    services:
      database:
        image: mysql:5.7
        environment:
          - MYSQL_DATABASE=testDB
          - MYSQL_ROOT_PASSWORD=password
          - MYSQL_ROOT_HOST=%
        ports:
          - "3306:3306"
        volumes:
          - ./mysql_config:/var/lib/mysql
        networks:
          - application_connect
      webapplicatoin:
        build: .
        ports:
          - "8080:8080"
        container_name: spring_application
        environment:
          - SPRING_DB_URL=database
        depends_on:
          - database
        networks:
          - applicatioconnect
    networks:
      application_connect:
          driver: bridge
    ```

    ```docker
    spring:
      datasource:
        # docker-compose를 사용하는 경우 mysql 이미지의 명으로 변경해야지 통신이 가능하다
        # 기존 localhost방식으로는 통신이 이루어 지지 않는다.
        url: jdbc:mysql://${SPRING_DB_URL}:3306/testDB
        username: root
        password: password
        driver-class-name: com.mysql.cj.jdbc.Driver

      jpa:
        database: mysql
        hibernate:
          ddl-auto: create
          show-sql: true
        properties:
          hibernate.format_sql: true

    logging:
      level:
        org.hibernate.SQL: debug
        org.hibernate.type: trace
    ```

    [[Docker] Docker-compose를 활용한 springboot+mysql](https://blog.naver.com/PostView.nhn?blogId=adamdoha&logNo=221870613809&parentCategoryNo=&categoryNo=60&viewDate=&isShowPopularPosts=true&from=search)

    도커 mysql 이미지 사용시 mysql url 변경 주시

    docker-compose를 통해 spring , mysql을 동시에 뛰울수가 있다
    docker-compose.yml은 상단의 코드와 같이 설정해주며 추가적으로 웹 어플리케이션 서버를 뛰우며 mysql에 접속하기 위해서 이름과 네트워크를 꼭 정의해주어야한다.
    현재 도커를 실행하면 동작을 하게 되며 아래와 같이 동작하는 것을 볼 수 있다.

    spring > application.yml 작성시 **datasource.URL을 주의하여 입력하여한다.
    URL작성시 jdbc:mysql://${컨테이너명}:${컨테이너 포트}/....
    입력하고 docker run 명령문 실행시 생성한 네트워크 또는 compose 네트워크를 입력해주어야한다.**

    ![Untitled](Docker%20%E1%84%92%E1%85%AA%E1%86%AF%E1%84%8B%E1%85%AD%E1%86%BC%20%E1%84%90%E1%85%A9%E1%84%90%E1%85%A9%E1%84%8B%E1%85%B5%20%E1%84%91%E1%85%B3%E1%84%85%E1%85%A9%E1%84%8C%E1%85%A6%E1%86%A8%E1%84%90%E1%85%B3%209d9aa06c31a6470f83b3122475863c23/Untitled.png)

    ```docker
    # 기존 docker-compose의 mysql을 연동하는 어플리케이션을 이미지를 뛰우기 위해서는 아래와 같이 명령어를 입력해야한다.
    docker run -it --name {컨테이너 명} --network {생성한 네트워크} -p {외부 포트}:{내부 포트} {이미지명}
    ```

3. maven를 활용하여 docker build and run 진행
4. maven을 활용하여 docker-compose build and run