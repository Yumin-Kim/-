# 부가 로직 구현(사용자 도메인 수정 및 데이터 베이스 변경)

**사용자 도메인 수정**은 쉘 스크립트를 통해 해결
**데이터 베이스 명 변경**은 데이터 베이스 명 변경하는 방법은 별도로 존재하지 않으며  새로 생성후 기존 정보 삭제하는 방식으로 해결

POST /api/student/siteInfo 
body {domainName: "",originDomainName : "" , databaseName:""}
요청을 통해서 수정하는 로직 구성하였고
기존 php로 구성되어있는 것을 Spring-boot Framework를 통해서 해결

jcraft 라이브러리를 활용하여 학교 서버 접속할 수 있는 ssh 유저를 통해 접근
그후 도메인 네임 수정시 ssh유저와 디렉토리 , 심볼릭 링크 파일 수정이 필요하기 때문에 ssh가 보유하고 있는 Shell Script에 변경하려는 도메인 네임을 인자 값으로 전달하여 수정하는 방식으로 구성하여 향후 php로도 실행 할 수 있도록 구성하였다

데이터베이스 명 수정 

## 사용자 도메인 수정 로직

- 요구 사항
    - SSH 접근은 하나의 유저 정보로만 접근 가능
    - sftp 프로토콜을 통해 파일 업로드를 하기 때문에 ssh 유저 명을 수정해야함
    - 도메인은 가상 서브 도메인을 제공하지 않고 디렉토리를 통해 접근하기 때문에 디렉토리 명 수정 및 심볼릭 링크 변경이 요구 되어 진다.
- 비즈니스 로직

    진행함에 리눅스 퍼미션에 대한 상식 요구되었다.아래 링크 참고하며

    requestBody값을 통해 받은 인자 값을 shell script의 인자값으로 전달하여 실행할 수 있도록 구현하였다.(도커환경에서 sudo 설치후 sudo 명령어를 사용할 수 있도록 진행 >> 기존 서버는 sudo로 생성하기때문에 동일하게 진행)

    진행에 있어 리눅스 환경에 익숙해지는 부분에서 시간 소모가 많았으며 아직 spring 코드 작성에는 큰어려움 없음

```bash
#! /bin/bash
# 주석
# $1 첫번째 인자 $2 두번째 인자

# 디렉토리 명 변경 로직
if [ -d $1 ];then
        mv $1 $2
fi

# 데이터베이스 명 변경 로직

#자동 실행
#! /bin/bash
service apache2 start
wait
service mysql start
wait
service ssh start

#매개변수를 통해 디렉토리 수정(도메인 주소 수정)
# docker 를 사용하여 진행하기 때문에 sudo 명령어가 먹히지 않아 사용하지 못함
usermod -l $2 $1
mv $1 $2
ln -Tfs /home/$2/Public /var/www/html/$1
mv /var/www/html/$1 /var/www/html/$2
```

[[기본] 리눅스의 퍼미션(권한)을 조정하기 (chmod, chown)](https://conory.com/blog/19194)

리눅스 퍼미션 공부

[[Linux] 다중 명령어(|, & 등), 자주 쓰는 명령어 ⑥](https://it-serial.tistory.com/64)

리눅스 다중 명령어 실행

[[CentOS 7] 'is not in the sudoers file' 해결 :: 마이자몽](https://myjamong.tistory.com/3)

ssh 유저 sudo 명령어 사용 권한 적용

[[Linux] 암호 없이 sudo 권한 얻기](https://minemanemo.tistory.com/110)

비밀번호 입력 안하게하기!

## 데이터 베이스 명 변경

데이터 베이스 명 변경은 찾아보기 전에는 변경하는 명령어가 존재하는줄 알았지만 기존 스키마의 테이블을 mysqldump를 통해 dump를 진행한후 사용자가 원하는 명으로 스키마 생성하여 다시 dump한 정보를 주입하는 방식으로 진행해야하는것을 알게 되었다.

또한 phpmyadmin에 접속해야하기때문에 계정 또한 삭제후 새로 생성하는 방식으로 진행하게 된다.

개발 하려 했으나 딱히 데이터 베이스 명을 바꾸는 일은 없을거 같아 일단 보류 상태

자료 링크

[[MySQL] 2. database schema 조회, 생성, 변경, 삭제, 이름변경](https://blog.jiniworld.me/60)

[MYSQL - 비밀번호& 확인 및 변경](https://velog.io/@michael00987/MYSQL-%EB%B9%84%EB%B0%80%EB%B2%88%ED%98%B8-%ED%99%95%EC%9D%B8-%EB%B0%8F-%EB%B3%80%EA%B2%BD)

[MySQL 계정 변경 및 간단한 사용법](https://m.blog.naver.com/PostView.naver?isHttpsRedirect=true&blogId=athena1028&logNo=20060725715)

[mysql 사용자추가/DB생성/권한부여](https://nickjoit.tistory.com/144)