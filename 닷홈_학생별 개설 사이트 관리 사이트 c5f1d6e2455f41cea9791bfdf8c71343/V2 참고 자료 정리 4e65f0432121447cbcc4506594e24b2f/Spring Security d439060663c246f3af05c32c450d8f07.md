# Spring Security

생성일: 2021년 9월 13일 오후 3:39

스프링 시큐리티를 사용하기 전에 간단한 용어 정리
* Authentication(인증)
- 인증이란 식별 가능한 정보를 이용하여 서비스에 등록 유저의 신원 입증하는 과정
- 나의 서비스에 등록된 사용자에게만 서비스를 제공하는 의미
* Authorization(인가)
- 인증만 가지고는 서비스 운영이 힘들며 사용자들마다 모든 서비스를 제공해야하나? 라는 관점에서 이와 같은 인가라는 개념이 나오게 되었다.
- 하나의 권한을 부여한다고 생각하는것을 좋을것 같다.
- 인가는 항상 앞에 있는 인증이라는 선행 프로세스가 필요

스프링 스큐리티에서 연관된 Filter Interface 및 class

interface: FilteChain , SecurityFilterChain , SecurityFilterChain
class : DefaultSecurityFilterChain , DelegatingFIlterProxy ,SecurityContextPersistenceFilter, CsrfFilter  , UsernamePasswordAuthenticationFilter 등등
많은 interface와 class로 구성된 Filter를 통해 인증 인가 처리를 spring - boot - security가 추상화하여 사용하기 쉽도로 구성되어 있다.

![Untitled](Spring%20Security%20d439060663c246f3af05c32c450d8f07/Untitled.png)

시큐리티 기본 동작 방식

Spring security를 설정하게 된다면 DispatcherServlet에 도달하기전에는 Servlet Filter구현체에게 걸리것이다.

여기서 Spring Security는 FilterChain들을 Servlet Container 기반의 필터 위에서 동작하기 위해 중간 연결을 위한 DlegatingFilterProxy를 사용한다.

DelegaingFilterProxy는 IOC컨테이너에서 관리하는 빈이 아닌 표준 Servlet Filter를 구현하고 있으며 요청을 위임할 FilterChainProxy를 가지고 있다.

![Untitled](Spring%20Security%20d439060663c246f3af05c32c450d8f07/Untitled%201.png)

DelegaingFilterProxy는 Servlet container기반의 필터 위에서 동작하기 위해서 중간 역할만을 하게된다.
FilterChainProxy에게 요청 처리를 위임하게된다.
FilterChainProxy는 역시 처리를 위임하기 위해 SecurityFilterChain을 가지고 있다.
SecurityFilterChain 하나만 존재하지 하지 않고 여러 개 존재하며 각기 다른 요청을 처리한다. 
~~해당 설정은 **WebSecurityConfigureAdapter**를 이용하여 쉽게 설정이 가능하다.

- [ ]  중간 정리[위임 과정??]  : **DelegaingFilterProxy >> FilterChainProxy >> SecurityFilterChain**
- SecurityContextPersistenceFilter

    해당 필터는 말 그대로 SercurityContext을 영속화하는 필터이며 SecurityContextRepository 인터페이스를 이용하여 영속화를 진행한다.

    기본 설정으로는 HttpSessionSecurityContextRepository 구현체를 이용한다.
    HttpSession의 Attribute에 SecurityContext가 저장

    영속화만 하는게 아니라 요청에 따라 repo에서 기본 설정에서는 Session되며 SecurityContext를 꺼내서 SecurityContext를 꺼내서 SecurityContextHolder에 넣어서 요청 전반에 걸쳐 SecurityContext를 사용할 수 있게 해준다.

    SecurityContext는 Authenication을 SecurityContextHolder에 담기위한 Wrapper class이다.

- UsernamePasswordAuthenticationFilter

    해당 필터는 뜻 그대로 아이디 패스워드 기반으로 인증을 담당하는 필터이다.
    해당 필터는 중요한 이유는 AbstractAuthenticationProcessingFitler 기점으로 확장 및 변경 포인트를 이해햐야한다.

    UsernamePassworedAuthenticationToken을 만들어서 AuthenticationManager 연결시키고 있다.
    AuthenticationManager는 인터페이스이며 실제 구현체 ProviderManager입니다.

    ProviderManger.authenticate()??

## 시큐리티 활용[기존 프로젝트 바로 응용할 수 있도록 구현]

중점 기존 스프링 시큐리티 부분을 모르고 설계하다보니 권한 즉 인가 부분에서 설계가 잘못 되었다는 것을 알게 되었다.
현재 데이터 베이스를 수정하게 된다면 학생 정보와 관리자 정보를 합쳐야하고 role이라는 칼럼을 추가하는 부분에서는 큰 어려움이 없지만 API스펙 자체가 변경되기 때문에 큰어려움이 존재한다.

최선의 방법
* controller에서 session CRUD 진행
* Security 사용하지 않고 그냥 진행하기
* Controller에서 테스트 성공시 애노테이션으로 만들어서 사용하기

인가하지 않고?? DB연동하여 관리할 수 있도록 제공
존재 controller >>  / , /admin/login , /general/login , /general , /admin , /admin/list
* /v1
* /v1/admin , /v1/admin/list , /v1/admin/login
* /v1/general , /v1/general/list , /v1/general/login